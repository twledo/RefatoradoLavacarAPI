<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Painel Admin - Lavacar</title>
    <style>
        body {
          font-family: Arial, sans-serif;
          background: #f9f9f9;
          padding: 20px;
        }

        .container {
          max-width: 700px;
          margin: auto;
          background: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 0 12px #ccc;
        }

        input,
        select,
        textarea,
        button {
          width: 100%;
          padding: 8px;
          margin: 8px 0;
          font-size: 16px;
        }

        button {
          cursor: pointer;
        }

        .service,
        .wash {
          border: 1px solid #ddd;
          border-radius: 4px;
          padding: 10px;
          margin-bottom: 10px;
        }

        .flex {
          display: flex;
          gap: 10px;
        }

        .flex button {
          flex: 1;
        }

        h2,
        h3 {
          border-bottom: 1px solid #ccc;
          padding-bottom: 6px;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>Serviços (JobWash)</h2>
    <div id="services-list"></div>

    <h3>Adicionar / Editar Serviço</h3>
    <input type="hidden" id="service-id" />
    <input id="service-name" placeholder="Nome do serviço" />
    <input id="service-price" type="number" step="0.01" placeholder="Preço" />
    <textarea id="service-desc" placeholder="Descrição"></textarea>


    <label>Quantidade máxima de lavagens por dia:</label>
    <input id="max-per-day" type="number" min="1" placeholder="Ex: 10" />

    <label>Horários disponíveis (separados por vírgula):</label>
    <input id="available-hours" placeholder="Ex: 08:00, 10:00, 14:00, 16:00" />

    <button onclick="saveService()">Salvar Serviço</button>
    <button onclick="saveConfig()">Salvar Data</button>

    <h2>Configurações de Agenda</h2>

    <hr />

    <h2>Agendamentos</h2>
    <div id="scheduled-list"></div>

    <button onclick="logout()">Sair</button>
</div>

<script>
    const API_URL = 'http://localhost:8080';
    let token = localStorage.getItem('token');

    if (!token) {
      alert('Você precisa estar logado');
      window.location.href = 'login.html';
    }

    // Função para escapar aspas
    function escapeQuotes(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    // =======================
    // === CRUD DE SERVIÇOS ===
    // =======================

    async function fetchServices() {
      try {
        const res = await fetch(`${API_URL}/owner/jobWash`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Erro ao carregar serviços');
        const services = await res.json();

        const container = document.getElementById('services-list');
        container.innerHTML = '';
        services.forEach(s => {
          const div = document.createElement('div');
          div.className = 'service';
          div.innerHTML = `
          <b>${s.name}</b> - R$${s.price.toFixed(2)}<br/>
          <small>${s.description}</small><br/>
          <div class="flex">
            <button onclick="editService(${s.id}, '${escapeQuotes(s.name)}', ${s.price}, '${escapeQuotes(s.description)}')">Editar</button>
            <button onclick="deleteService(${s.id})" style="background:#c00; color:#fff;">Excluir</button>
          </div>
        `;
          container.appendChild(div);
        });
      } catch (e) {
        alert(e.message);
      }
    }

    function editService(id, name, price, desc) {
      document.getElementById('service-id').value = id;
      document.getElementById('service-name').value = name;
      document.getElementById('service-price').value = price;
      document.getElementById('service-desc').value = desc;
    }

    async function saveService() {
      const id = document.getElementById('service-id').value;
      const name = document.getElementById('service-name').value.trim();
      const price = parseFloat(document.getElementById('service-price').value);
      const desc = document.getElementById('service-desc').value.trim();

      if (!name || isNaN(price) || price <= 0) {
        alert('Preencha nome e preço corretamente.');
        return;
      }

      const body = {
        name,
        price,
        description: desc
      };

      const method = id ? 'PUT' : 'POST';
      const url = id
        ? `${API_URL}/owner/jobWash/${id}`
        : `${API_URL}/owner/jobWash`;

      try {
        const res = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error('Erro ao salvar serviço');

        document.getElementById('service-id').value = '';
        document.getElementById('service-name').value = '';
        document.getElementById('service-price').value = '';
        document.getElementById('service-desc').value = '';

        fetchServices();
      } catch (e) {
        alert(e.message);
      }
    }


    async function deleteService(id) {
      if (!confirm('Confirma exclusão do serviço?')) return;
      try {
        const res = await fetch(`${API_URL}/owner/jobWash/${id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Erro ao excluir serviço');
        alert('Serviço excluído!');
        fetchServices();
      } catch (e) {
        alert(e.message);
      }
    }

    function clearForm() {
      document.getElementById('service-id').value = '';
      document.getElementById('service-name').value = '';
      document.getElementById('service-price').value = '';
      document.getElementById('service-desc').value = '';
    }

    // =============================
    // === AGENDAMENTOS REALIZADOS ===
    // =============================

    async function listScheduled() {
      try {
        const res = await fetch(`${API_URL}/public/schedules`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Erro ao carregar agendamentos');
        const schedules = await res.json();

        const container = document.getElementById('scheduled-list');
        container.innerHTML = '';
        schedules.forEach(s => {
          const dt = new Date(s.dateTime);
          const date = dt.toLocaleDateString('pt-BR');
          const hour = dt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

          const div = document.createElement('div');
          div.className = 'wash';
          div.innerHTML = `
        <b>${s.nameClient}</b> | ${s.phone} | ${s.modelCar}<br/>
        Serviço: ${s.jobWash?.name || 'N/A'}<br/>
        Data: ${date} | Hora: ${hour}<br/>
        Obs: ${s.descriptionService || '-'}<br/>
        Status: ${s.status || 'Pendente'}
      `;
          container.appendChild(div);
        });
      } catch (e) {
        alert(e.message);
      }
    }



    // =====================================
    // === CONFIGURAÇÕES DE AGENDA DIÁRIA ===
    // =====================================

    function saveConfig() {
      const maxPerDay = parseInt(document.getElementById('max-per-day').value);
      const hours = document.getElementById('available-hours').value.trim();

      if (isNaN(maxPerDay) || maxPerDay <= 0) {
        alert('Informe um número válido de lavagens por dia.');
        return;
      }

      if (!hours) {
        alert('Informe pelo menos um horário disponível.');
        return;
      }

      const config = {
        maxPerDay,
        hours: hours.split(',').map(h => h.trim())
      };

      localStorage.setItem('scheduleConfig', JSON.stringify(config));
      alert('Configuração salva!');
    }

    function loadConfig() {
      const config = JSON.parse(localStorage.getItem('scheduleConfig'));
      if (config) {
        document.getElementById('max-per-day').value = config.maxPerDay;
        document.getElementById('available-hours').value = config.hours.join(', ');
      }
    }

    // ==================
    // === LOGOUT =======
    // ==================

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }

    // ==================
    // === INICIALIZA ===
    // ==================

    fetchServices();
    listScheduled();
    loadConfig();
</script>


</body>

</html>